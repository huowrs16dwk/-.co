
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/bundle.css">
    <title>practical nix flakes</title>
  </head>
  <body>
    <div class="wrapper">
    
<article>

<h1>practical nix flakes</h1>
<p>If you are running nixos, you already have the nix build system.  Otherwise, you'll need to install it</p>
<pre><code class="language-bash">curl -L https://nixos.org/nix/install | sh
</code></pre>
<p>Now you'll need to enable flakes</p>
<pre><code class="language-bash">mkdir -p ~/.config/nix
echo &quot;experimental-features = nix-command flakes&quot; &gt; ~/.config/nix/nix.conf

# now nix flake command should work
nix flake --help
</code></pre>
<p>For setup, that's pretty much all you need to do.  If you already have a project with a working <code>flake.nix</code>
file then you are off to the races.</p>
<pre><code class="language-bash"># build the default target
nix build

# enter quick shell with dependencies available
nix shell

# enter development shell for reproducable builds
nix develop
</code></pre>
<p>But what if you don't have a flake file yet?  Here are some examples for various programming languages.</p>
<h2>ruby</h2>
<p>To generate the gemset.nix you'll need to use bundix:  <code>nix-shell -p bundix</code></p>
<pre><code>{
  description = &quot;A Ruby on Rails project&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      system = &quot;x86_64-linux&quot;; # Adjust the system if necessary
      pkgs = import nixpkgs {
        inherit system;
      };

      # Specify the Ruby version you want to use
      ruby = pkgs.ruby_3_2; # As an example, using Ruby 3.2

      # Define the Ruby on Rails environment
      railsEnv = pkgs.bundlerEnv {
        name = &quot;my-rails-app&quot;;
        inherit ruby;
        gemfile = ./Gemfile;
        lockfile = ./Gemfile.lock;
        gemset = ./gemset.nix; # Generated from Gemfile.lock
      };
    in
    {
      packages.${system}.default = railsEnv;

      defaultPackage.${system} = railsEnv;

      # Define a development shell environment
      devShells.${system} = pkgs.mkShell {
        buildInputs = [
          railsEnv # This provides the Ruby environment with all gems specified in Gemfile
          # Include other build inputs like databases, etc.
        ];
      };
    };
}
</code></pre>
<h2>python</h2>
<pre><code>{
  description = &quot;A Python project with Numpy and Pandas&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      system = &quot;x86_64-linux&quot;;

      # Obtain the package set from nixpkgs
      pkgs = import nixpkgs {
        inherit system;
      };

      # Function to create a Python environment
      pythonEnv = pkgs.python3.withPackages (ps: with ps; [
        numpy
        pandas
        # You can add more Python packages here, e.g., matplotlib, scipy, etc.
      ]);

    in
    {
      packages.${system}.default = pythonEnv;

      defaultPackage.${system} = pythonEnv;

      # Define a development shell for `nix develop`
      devShells.${system} = pkgs.mkShell {
        buildInputs = [ pythonEnv ];

        # Set PYTHONPATH to make sure Python can find the installed packages
        shellHook = ''
            export PYTHONPATH=${pythonEnv}/${pkgs.python3.sitePackages}
        '';
      };
    };
}
</code></pre>
<h2>nodejs</h2>
<pre><code>{
  description = &quot;A Node.js project&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      system = &quot;x86_64-linux&quot;;
      pkgs = import nixpkgs {
        inherit system;
      };

      nodePackages = pkgs.nodePackages // {
        package = pkgs.nodePackages.package.override {
          src = self;
        };
      };

      # Create the development environment
      devShell = pkgs.mkShell {
        buildInputs = [
          pkgs.nodejs_20
        ];

        # The following line can be uncommented to automatically install npm dependencies
        # shellHook = ''
        #   npm install
        # '';
      };
    in
    {
      packages.${system}.default = nodePackages;
      devShells.${system}.default = devShell;
    };
}
</code></pre>
<h2>java</h2>
<pre><code>{
  description = &quot;A simple Java project&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      # Import nixpkgs
      pkgs = import nixpkgs {
        system = &quot;x86_64-linux&quot;;
      };

      # Define the Java environment
      javaEnv = pkgs.mkShell {
        buildInputs = [ pkgs.jdk19_headless pkgs.maven ];
      };
    in
    {
      packages.x86_64-linux.default = pkgs.stdenv.mkDerivation {
        pname = &quot;my-java-app&quot;;
        version = &quot;1.0&quot;;
        src = self;

        # Set JAVA_HOME
        buildInputs = [ pkgs.jdk19_headless pkgs.maven ];

        # The build phase
        buildPhase = ''
          mvn compile
        '';

        # The install phase
        installPhase = ''
          mvn package
        '';
      };

      # Define a development shell for `nix develop`
      devShells.x86_64-linux = javaEnv;
    };
}
</code></pre>
<p>Note: <code>nix build</code> will not have internet access to the maven repo, so you'll need to download the packages with <code>mvn dependency:go-offline</code></p>
<h2>rust</h2>
<pre><code>{
  description = &quot;A basic Rust application&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      # Import nixpkgs for the x86_64-linux system
      pkgs = import nixpkgs {
        system = &quot;x86_64-linux&quot;;
      };

      # Define the Rust package
      rustPackage = pkgs.rustPlatform.buildRustPackage {
        pname = &quot;my-rust-app&quot;;
        version = &quot;0.1.0&quot;;
        src = pkgs.lib.cleanSource ./.;

        # The hash for Cargo.lock
        cargoSha256 = &quot;w9sBUL9eYOjFDNBhB35JImFjexnKM0nY7C7idCXNyKg=&quot;;

        # Set release mode explicitly, though it is the default
        cargoBuildFlags = [ &quot;--release&quot; ];
      };
    in
    {
      packages.x86_64-linux.default = rustPackage;

      defaultPackage.x86_64-linux = rustPackage;

      # Define a development environment for this project
      devShells.x86_64-linux = pkgs.mkShell {
        buildInputs = [
          pkgs.rustc
          pkgs.cargo
          # Include any other dependencies here
        ];
      };
    };
}
</code></pre>
<h2>c++</h2>
<pre><code>{
  description = &quot;A C++ project with CMake and GCC&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      # Import the nixpkgs for the specified system
      system = &quot;x86_64-linux&quot;; # Change this to your specific system if needed
      pkgs = import nixpkgs {
        inherit system;
      };

      # Create the development environment
      devEnv = pkgs.mkShell {
        nativeBuildInputs = [
          pkgs.cmake
          pkgs.gcc
          pkgs.make
          # Add any other dependencies your project may need, e.g.:
          # pkgs.boost
          # pkgs.eigen
          # etc.
        ];

        # Optionally set environment variables, like:
        # CXXFLAGS=&quot;-O3&quot;
        # LDFLAGS=&quot;-flto&quot;
      };
    in
    {
      # The default package to build
      packages.${system}.default = pkgs.stdenv.mkDerivation {
        pname = &quot;my-cpp-app&quot;;
        version = &quot;1.0&quot;;
        src = self; # or ./. if you want to point to the root of the project

        nativeBuildInputs = [ pkgs.cmake pkgs.gcc ];

        # The build phase (CMake in this case)
        buildPhase = ''
          cmake .
          make
        '';

        # The install phase
        installPhase = ''
          mkdir -p $out/bin
          cp my-cpp-app $out/bin/
        '';

        # You can specify more phases like checkPhase for tests, if necessary.
      };

      # Define the development shell for `nix develop`
      devShells.${system} = devEnv;

      # The default application when running `nix run`
      defaultApp.${system} = self.packages.${system}.default;
    };
}
</code></pre>
<h2>c++ cross compiling for x86 and aarch64</h2>
<pre><code>{
  description = &quot;A C++ project with cross-compilation for aarch64-linux&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };

  outputs = { self, nixpkgs }:
    let
      # Cross-compilation target
      crossSystem = &quot;aarch64-linux&quot;;

      # Import nixpkgs for the host system
      hostPkgs = import nixpkgs {
        system = &quot;x86_64-linux&quot;;
        overlays = [];
      };

      # Import nixpkgs with cross-compilation support
      crossPkgs = import nixpkgs {
        system = &quot;x86_64-linux&quot;;
        crossSystem = {
          config = crossSystem;
          # Additional cross-compilation configuration goes here
        };
      };
    in {
      packages.x86_64-linux = {
        my-cpp-app = hostPkgs.stdenv.mkDerivation {
          pname = &quot;my-cpp-app&quot;;
          version = &quot;1.0&quot;;
          src = self;

          nativeBuildInputs = with hostPkgs; [ cmake pkg-config ];

          buildInputs = with hostPkgs; [
            # Dependencies for the target architecture
          ];

          buildPhase = ''
            cmake .
            make
          '';

          installPhase = ''
            mkdir -p $out/bin/x86
            cp my-cpp-app $out/bin/x86
          '';
        };

        my-cpp-app-aarch64 = crossPkgs.stdenv.mkDerivation {
          pname = &quot;my-cpp-app&quot;;
          version = &quot;1.0&quot;;
          src = self;

          nativeBuildInputs = with hostPkgs; [ cmake pkg-config ];

          buildInputs = with crossPkgs; [
            # Dependencies for the target architecture
          ];

          buildPhase = ''
            cmake .
            make
          '';

          installPhase = ''
            mkdir -p $out/bin/arm
            cp my-cpp-app $out/bin/arm
          '';
        };
      };

      # Define the development shell for `nix develop`
      devShells.x86_64-linux = hostPkgs.mkShell {
        nativeBuildInputs = with hostPkgs; [ cmake pkg-config ];
      };
    };
}
</code></pre>
<p>The arm target can be compiled by specifying the target</p>
<pre><code class="language-bash"># build for x86
nix build .\#my-cpp-app

# build for arm
nix build .\#my-cpp-app-aarch64
</code></pre>


</article>


    </div>

    <div class="footer">


<nav>
  <ul>
    
      <li><a href="/posts/ghidra-debugging-with-lldb/">[ 2023-11-18 ] ghidra debugging with lldb</a></li>
    
      <li><a href="/posts/practical-nix-flakes/">[ 2023-11-09 ] practical nix flakes</a></li>
    
      <li><a href="/posts/nixos-docker-llama-gpt/">[ 2023-10-07 ] nixos docker llama-gpt</a></li>
    
      <li><a href="/posts/archinstall-with-encrypted-btrfs/">[ 2023-09-14 ] archinstall with encrypted btrfs</a></li>
    
      <li><a href="/posts/encrypted-usb-sticks/">[ 2023-08-25 ] encrypted usb sticks</a></li>
    
      <li><a href="/posts/home-lab-hybrid-cloud-setup/">[ 2023-08-23 ] home lab hybrid cloud setup</a></li>
    
      <li><a href="/posts/vpn-sharing/">[ 2023-08-20 ] vpn sharing</a></li>
    
      <li><a href="/posts/command-line-tutorial/">[ 2023-08-15 ] command line tutorial</a></li>
    
      <li><a href="/posts/connecting-to-github-securely/">[ 2023-07-30 ] connecting to github securely</a></li>
    
  </ul>
</nav>


<div class="home">
  <a href="/">浪人</a>
</div>

</div>

  </body>
</html>
